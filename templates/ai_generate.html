{% extends "base.html" %}
{% block content %}

<h2 style="margin:0 0 10px 0;">AI Generate</h2>
<p style="margin:0 0 18px 0;color:#9ca3af;">Generate text-based or media-based questions. The generator will strictly follow Category + Subtopic + Hint + Difficulty.</p>

<form method="post" style="max-width:1100px;" id="aiForm">
  <div class="midan-field">
    <label class="midan-label">Category</label>
    <select class="midan-input" name="category_id" id="category_id">
      {% for c in categories %}
        <option value="{{ c.id }}" {% if selected_category_id and c.id == selected_category_id %}selected{% endif %}>
          {{ (c.name_en or '(no EN)') }} / {{ (c.name_ar or '(no AR)') }}
        </option>
      {% endfor %}
    </select>
    <div class="midan-help">Region scope is set per question generation (Saudi / Global / Mixed).</div>
  </div>

  <div class="midan-grid4 midan-rowgap">
    <div class="midan-field">
      <label class="midan-label">Difficulty</label>
      <select class="midan-input" name="difficulty" id="difficulty">
        <option value="ladder">Ladder (Easy → Medium → Hard)</option>
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
        <option value="expert">Expert</option>
      </select>
      <div class="midan-help">Ladder generates <b>count × 3</b> questions: Easy, Medium, then Hard.</div>
    </div>

    <div class="midan-field">
      <label class="midan-label">Region scope</label>
      <select class="midan-input" name="region" id="region">
        <option value="saudi">Saudi</option>
        <option value="global" selected>Global</option>
        <option value="mixed">Mixed</option>
      </select>
    </div>

    <div class="midan-field" id="saudi_ratio_wrap">
      <label class="midan-label">Saudi ratio (0–1)</label>
      <input class="midan-input" name="saudi_ratio" id="saudi_ratio" type="number" min="0" max="1" step="0.1" value="0.7">
      <div class="midan-help">Shown only for <b>Mixed</b> scope. 1.0=Saudi-centric, 0.0=Global.</div>
    </div>

    <div class="midan-field">
      <label class="midan-label">Current affairs</label>
      <select class="midan-input" name="current_affairs" id="current_affairs">
        <option value="no" selected>No</option>
        <option value="yes">Yes</option>
      </select>
      <div class="midan-help">If Yes, current-affairs validation agent runs after generation.</div>
    </div>
  </div>

  <div class="midan-grid3 midan-rowgap">
    <div class="midan-field">
      <label class="midan-label">Question mode</label>
      <select class="midan-input" name="question_mode" id="question_mode">
        <option value="text" selected>Text-based</option>
        <option value="media">Media-based (question depends on media)</option>
      </select>
    </div>

    <div class="midan-field" id="media_type_wrap">
      <label class="midan-label">Media type</label>
      <select class="midan-input" name="media_type" id="media_type">
        <option value="picture" selected>Picture</option>
        <option value="logo">Logo</option>
        <option value="audio">Audio</option>
        <option value="video">Video</option>
      </select>
      <div class="midan-help">Used only for media-based mode.</div>
    </div>

    <div class="midan-field">
      <label class="midan-label">Game type</label>
      <select class="midan-input" name="game_type" id="game_type">
        <option value="mcq_selection" selected>MCQ</option>
        <option value="text_input">Text input</option>
        <option value="be_loud">Be Loud</option>
      </select>
    </div>
  </div>

  <div class="midan-grid2 midan-rowgap">
    <div class="midan-field">
      <label class="midan-label">Count</label>
      <input class="midan-input" name="count" type="number" min="1" max="50" value="10">
    </div>

    <div class="midan-field">
      <label class="midan-label">Subtopic (optional)</label>
      <input class="midan-input" name="subtopic" id="subtopic" list="subtopic_suggestions" placeholder="Auto-suggested; you can edit">
      <datalist id="subtopic_suggestions"></datalist>
      <div class="midan-help" id="subtopic_help"></div>
    </div>
  </div>

  <div class="midan-field midan-rowgap">
    <label class="midan-label">Hint (optional)</label>
    <textarea class="midan-input" name="hint" rows="3" placeholder="Optional prompt/constraint to narrow the question"></textarea>
  </div>

  <button class="btn" type="submit">Generate</button>
</form>

<script>
(function(){
  const region = document.getElementById('region');
  const saWrap = document.getElementById('saudi_ratio_wrap');
  const qm = document.getElementById('question_mode');
  const mediaWrap = document.getElementById('media_type_wrap');
  function toggleMediaType(){
    if(!qm || !mediaWrap) return;
    mediaWrap.style.display = (qm.value === 'MEDIA') ? 'block' : 'none';
  }
  function toggleSaudiRatio(){
    if(!region || !saWrap) return;
    saWrap.style.display = (region.value === 'mixed') ? 'block' : 'none';
  }
  if(region) region.addEventListener('change', toggleSaudiRatio);
  toggleSaudiRatio();

    if(qm) qm.addEventListener('change', toggleMediaType);
  toggleMediaType();
const cat = document.getElementById('category_id');
  const dl = document.getElementById('subtopic_suggestions');
  const help = document.getElementById('subtopic_help');
  async function loadSubtopics(){
    if(!cat || !dl) return;
    dl.innerHTML = '';
    if(help) help.textContent = '';
    try{
      const r = await fetch('/api/categories/' + encodeURIComponent(cat.value) + '/subtopics');
      const data = await r.json();
      const items = data.items || [];
      items.slice(0, 20).forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t;
        dl.appendChild(opt);
      });
      if(help){
        help.textContent = items.length ? ('Suggested from existing data (' + items.length + ')') : 'No previous subtopics found; type one or use suggestions from AI.';
      }
    }catch(e){
      if(help) help.textContent = '';
    }
  }
  if(cat) cat.addEventListener('change', loadSubtopics);
  loadSubtopics();
})();
</script>


<script>
(function(){
  const modeSel = document.getElementById('question_mode');
  const mediaWrap = document.getElementById('media_type_wrap');
  function toggleMediaType(){
    if(!modeSel || !mediaWrap) return;
    const isMedia = (modeSel.value || '').toLowerCase() === 'media';
    mediaWrap.style.display = isMedia ? 'block' : 'none';
  }
  if(modeSel) modeSel.addEventListener('change', toggleMediaType);
  toggleMediaType();
})();
</script>


{% endblock %}